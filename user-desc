$DC_IP = "192.168.0.49"
$User = 'texas\testaccount'
$Pass = 'password123!'

Write-Host "--- DIAGNOSTIC MODE ---" -ForegroundColor Cyan

# STEP 1: Check Network Port
# We check Port 389 (LDAP) and 3268 (Global Catalog)
$Port389 = Test-NetConnection -ComputerName $DC_IP -Port 389 -WarningAction SilentlyContinue
$Port3268 = Test-NetConnection -ComputerName $DC_IP -Port 3268 -WarningAction SilentlyContinue

if ($Port389.TcpTestSucceeded) { Write-Host "Port 389 (LDAP): OPEN" -ForegroundColor Green } 
else { Write-Host "Port 389 (LDAP): BLOCKED/CLOSED" -ForegroundColor Red }

if ($Port3268.TcpTestSucceeded) { Write-Host "Port 3268 (GC): OPEN" -ForegroundColor Green } 
else { Write-Host "Port 3268 (GC): BLOCKED/CLOSED" -ForegroundColor Red }

# STEP 2: Test Credentials against RootDSE
# This ignores the 'DC=texas...' path and just asks the server "Who are you?"
Write-Host "`nAttempting to Bind to RootDSE..." -ForegroundColor Cyan

try {
    # Bind to RootDSE
    $RootDSE = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$DC_IP/RootDSE", $User, $Pass)
    
    # Force it to talk to us
    $DefaultNamingContext = $RootDSE.defaultNamingContext
    
    Write-Host "SUCCESS! Credentials are valid." -ForegroundColor Green
    Write-Host "Correct Domain Path is: $DefaultNamingContext" -ForegroundColor Yellow
    
    # STEP 3: Run the Search using the path the Server gave us
    Write-Host "`nRunning Search using auto-discovered path..." -ForegroundColor Cyan
    
    $SearchRoot = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$DC_IP/$DefaultNamingContext", $User, $Pass)
    $Searcher = [adsisearcher]$SearchRoot
    $Searcher.Filter = "(&(objectClass=user)(objectCategory=person))"
    
    # Limit results to 1 to test speed
    $Searcher.SizeLimit = 1
    
    $Result = $Searcher.FindOne()
    
    if ($Result) {
        Write-Host "Search Succeeded! Found user: $($Result.Properties.name)" -ForegroundColor Green
    } else {
        Write-Host "Search ran, but found 0 users." -ForegroundColor Yellow
    }

}
