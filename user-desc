# 2. Bind to the Domain Root
Write-Host "Binding to LDAP..." -ForegroundColor Cyan
$Root = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$DC_IP/DC=texas,DC=local", $User, $Pass)

# 3. Create Searcher
$Searcher = [adsisearcher]$Root
$Searcher.ReferralChasing = [System.DirectoryServices.ReferralChasingOption]::None
$Searcher.PageSize = 1000
$Searcher.SearchScope = "Subtree"

# 4. Filter: Find all people
$Searcher.Filter = "(&(objectClass=user)(objectCategory=person))"

# 5. Run the Search and Store Raw Results
Write-Host "Querying Domain Controller..." -ForegroundColor Cyan
try {
    $RawResults = $Searcher.FindAll()
    
    # Check if we found anything before trying to process
    if ($RawResults.Count -eq 0) {
        Write-Host "Success, but 0 users were found. Check the Base DN path." -ForegroundColor Yellow
    } 
    else {
        # 6. Process results into a Clean List variable
        $CleanList = $RawResults | ForEach-Object {
            $Obj = $_.Properties
            [PSCustomObject]@{
                Name = $Obj.name[0]
                DistinguishedName = $Obj.distinguishedname[0]
            }
        }

        # 7. Display the table (This was the part breaking before)
        Write-Host "Found $($CleanList.Count) users:" -ForegroundColor Green
        $CleanList | Format-Table -AutoSize
    }

} catch {
    Write-Host "CRITICAL ERROR: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.Exception.InnerException) {
        Write-Host "Reason: $($_.Exception.InnerException.Message)" -ForegroundColor Yellow
    }
}
