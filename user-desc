# 2. BIND TO GLOBAL CATALOG (Port 3268)
# We added ":3268" after the IP address.
Write-Host "Binding to Global Catalog..." -ForegroundColor Cyan
$Root = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$DC_IP:3268/DC=texas,DC=local", $User, $Pass)

# 3. Create Searcher
$Searcher = [adsisearcher]$Root

# We still keep this 'None' just to be safe, though GC usually ignores it.
$Searcher.ReferralChasing = [System.DirectoryServices.ReferralChasingOption]::None

$Searcher.PageSize = 1000
$Searcher.SearchScope = "Subtree"

# 4. Filter: Find all people
$Searcher.Filter = "(&(objectClass=user)(objectCategory=person))"

# 5. Run the Search
Write-Host "Querying..." -ForegroundColor Cyan

try {
    $RawResults = $Searcher.FindAll()
    
    if ($RawResults.Count -eq 0) {
        Write-Host "Success, but 0 users were found." -ForegroundColor Yellow
    } 
    else {
        $CleanList = $RawResults | ForEach-Object {
            $Obj = $_.Properties
            [PSCustomObject]@{
                Name = $Obj.name[0]
                DistinguishedName = $Obj.distinguishedname[0]
            }
        }

        Write-Host "Found $($CleanList.Count) users:" -ForegroundColor Green
        $CleanList | Format-Table -AutoSize
    }

} catch {
    Write-Host "CRITICAL ERROR: $($_.Exception.Message)" -ForegroundColor Red
}
