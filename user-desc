# 1. Credentials
$DC_IP = "192.168.0.49"
$User = 'texas\testaccount'
$Pass = 'password123!'

# 2. Bind to the specific Domain Root
# (If you don't use the specific DN, referrals happen much more often)
$Root = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$DC_IP/DC=texas,DC=local", $User, $Pass)

# 3. Create Searcher
$Searcher = [adsisearcher]$Root

# --- THE FIX IS HERE ---
# Tell the searcher to ignore "Go ask that guy" messages.
$Searcher.ReferralChasing = [System.DirectoryServices.ReferralChasingOption]::None
# -----------------------

# 4. Filter & Scope
$Searcher.Filter = "(&(objectClass=user)(objectCategory=person))"
$Searcher.PageSize = 1000
$Searcher.SearchScope = "Subtree"

Write-Host "Searching..." -ForegroundColor Cyan

# 5. Run
try {
    $Results = $Searcher.FindAll()
    
    if ($Results.Count -eq 0) {
        Write-Host "No results found. Check your Filter." -ForegroundColor Yellow
    } else {
        foreach ($Res in $Results) {
            $Obj = $Res.Properties
            [PSCustomObject]@{
                Name = $Obj.name[0]
                DistinguishedName = $Obj.distinguishedname[0]
            }
        } | Format-Table -AutoSize
    }
} catch {
    Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
}
